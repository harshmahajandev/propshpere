<div class="users-container">
  <!-- Header -->
  <div class="users-header">
    <div class="header-content">
      <h1><mat-icon>people</mat-icon> User Management</h1>
      <p>Manage users, roles, and permissions</p>
    </div>
    <div class="header-actions">
      <button 
        mat-raised-button 
        color="primary" 
        (click)="openCreateDialog()"
        [disabled]="!hasPermission(Resource.USERS, Action.CREATE)">
        <mat-icon>person_add</mat-icon>
        Add User
      </button>
    </div>
  </div>

  <!-- Filters and Search -->
  <mat-card class="filters-card">
    <div class="filters-container">
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>Search users</mat-label>
        <input matInput [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()">
        <mat-icon matPrefix>search</mat-icon>
        <mat-hint>Search by name, email, or username</mat-hint>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Role</mat-label>
        <mat-select [(ngModel)]="selectedRoleId" (selectionChange)="onRoleFilterChange()">
          <mat-option value="">All Roles</mat-option>
          <mat-option *ngFor="let role of roles" [value]="role.id">{{ role.displayName }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="selectedStatus" (selectionChange)="onStatusFilterChange()">
          <mat-option value="">All Status</mat-option>
          <mat-option value="active">Active</mat-option>
          <mat-option value="inactive">Inactive</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-checkbox [(ngModel)]="showInactive" (change)="onShowInactiveChange()">
        Show Inactive
      </mat-checkbox>

      <div class="view-toggle">
        <mat-button-toggle-group [(value)]="viewMode" aria-label="View mode">
          <mat-button-toggle value="grid" matTooltip="Grid View" (click)="onViewModeChange('grid')">
            <mat-icon>grid_view</mat-icon>
            <span class="toggle-label">Grid</span>
          </mat-button-toggle>
          <mat-button-toggle value="list" matTooltip="List View" (click)="onViewModeChange('list')">
            <mat-icon>view_list</mat-icon>
            <span class="toggle-label">List</span>
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>
    </div>
  </mat-card>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading users...</p>
  </div>

  <!-- Users Content -->
  <div *ngIf="!isLoading" class="users-content">
    <!-- Grid View -->
    <div *ngIf="viewMode === 'grid'" class="users-grid">
      <mat-card *ngFor="let user of paginatedUsers" class="user-card">
        <mat-card-header>
          <div mat-card-avatar class="user-avatar">
            <mat-icon>person</mat-icon>
          </div>
          <mat-card-title>{{ user.fullName }}</mat-card-title>
          <mat-card-subtitle>{{ user.email }}</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="user-info">
            <div class="info-item">
              <mat-icon>person</mat-icon>
              <span>{{ user.username }}</span>
            </div>
            <div class="info-item" *ngIf="user.phone">
              <mat-icon>phone</mat-icon>
              <span>{{ user.phone }}</span>
            </div>
            <div class="info-item">
              <mat-icon>work</mat-icon>
              <span>{{ getRoleDisplayName(user.roles[0]?.id || '') }}</span>
            </div>
            <div class="info-item">
              <mat-icon [color]="getStatusColor(user.isActive)">circle</mat-icon>
              <span>{{ getStatusText(user.isActive) }}</span>
            </div>
          </div>
        </mat-card-content>
        
        <mat-card-actions>
          <button 
            mat-icon-button 
            (click)="openEditDialog(user)"
            [disabled]="!hasPermission(Resource.USERS, Action.EDIT)"
            matTooltip="Edit User">
            <mat-icon>edit</mat-icon>
          </button>
          <button 
            mat-icon-button 
            (click)="toggleUserStatus(user)"
            [disabled]="!hasPermission(Resource.USERS, Action.EDIT)"
            [matTooltip]="user.isActive ? 'Deactivate User' : 'Activate User'">
            <mat-icon>{{ user.isActive ? 'block' : 'check_circle' }}</mat-icon>
          </button>
          <button 
            mat-icon-button 
            (click)="resetPassword(user)"
            [disabled]="!hasPermission(Resource.USERS, Action.MANAGE)"
            matTooltip="Reset Password">
            <mat-icon>lock_reset</mat-icon>
          </button>
          <button 
            mat-icon-button 
            color="warn"
            (click)="deleteUser(user)"
            [disabled]="!hasPermission(Resource.USERS, Action.DELETE)"
            matTooltip="Delete User">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- List View -->
    <div *ngIf="viewMode === 'list'" class="users-list">
      <mat-table [dataSource]="paginatedUsers" class="users-table">
        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <mat-header-cell *matHeaderCellDef>Name</mat-header-cell>
          <mat-cell *matCellDef="let user">
            <div class="user-cell">
              <div class="user-avatar-small">
                <mat-icon>person</mat-icon>
              </div>
              <div class="user-details">
                <div class="user-name">{{ user.fullName }}</div>
                <div class="user-email">{{ user.email }}</div>
              </div>
            </div>
          </mat-cell>
        </ng-container>

        <!-- Username Column -->
        <ng-container matColumnDef="username">
          <mat-header-cell *matHeaderCellDef>Username</mat-header-cell>
          <mat-cell *matCellDef="let user">{{ user.username }}</mat-cell>
        </ng-container>

        <!-- Role Column -->
        <ng-container matColumnDef="role">
          <mat-header-cell *matHeaderCellDef>Role</mat-header-cell>
          <mat-cell *matCellDef="let user">
            <div class="role-chips">
              <mat-chip *ngFor="let role of user.roles">{{ role.displayName }}</mat-chip>
            </div>
          </mat-cell>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <mat-header-cell *matHeaderCellDef>Status</mat-header-cell>
          <mat-cell *matCellDef="let user">
            <mat-chip [color]="getStatusColor(user.isActive)" selected>
              {{ getStatusText(user.isActive) }}
            </mat-chip>
          </mat-cell>
        </ng-container>

        <!-- Last Login Column -->
        <ng-container matColumnDef="lastLogin">
          <mat-header-cell *matHeaderCellDef>Last Login</mat-header-cell>
          <mat-cell *matCellDef="let user">
            {{ user.lastLoginAt | date:'short' }}
          </mat-cell>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
          <mat-cell *matCellDef="let user">
            <button 
              mat-icon-button 
              (click)="openEditDialog(user)"
              [disabled]="!hasPermission(Resource.USERS, Action.EDIT)"
              matTooltip="Edit User">
              <mat-icon>edit</mat-icon>
            </button>
            <button 
              mat-icon-button 
              (click)="toggleUserStatus(user)"
              [disabled]="!hasPermission(Resource.USERS, Action.EDIT)"
              [matTooltip]="user.isActive ? 'Deactivate User' : 'Activate User'">
              <mat-icon>{{ user.isActive ? 'block' : 'check_circle' }}</mat-icon>
            </button>
            <button 
              mat-icon-button 
              (click)="resetPassword(user)"
              [disabled]="!hasPermission(Resource.USERS, Action.MANAGE)"
              matTooltip="Reset Password">
              <mat-icon>lock_reset</mat-icon>
            </button>
            <button 
              mat-icon-button 
              color="warn"
              (click)="deleteUser(user)"
              [disabled]="!hasPermission(Resource.USERS, Action.DELETE)"
              matTooltip="Delete User">
              <mat-icon>delete</mat-icon>
            </button>
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="['name', 'username', 'role', 'status', 'lastLogin', 'actions']"></mat-header-row>
        <mat-row *matRowDef="let row; columns: ['name', 'username', 'role', 'status', 'lastLogin', 'actions'];"></mat-row>
      </mat-table>
    </div>

    <!-- Pagination -->
    <mat-paginator
      [length]="totalUsers"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredUsers.length === 0" class="empty-state">
    <mat-icon>people_outline</mat-icon>
    <h3>No users found</h3>
    <p>Try adjusting your search criteria or create a new user.</p>
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      <mat-icon>person_add</mat-icon>
      Add User
    </button>
  </div>
</div>
